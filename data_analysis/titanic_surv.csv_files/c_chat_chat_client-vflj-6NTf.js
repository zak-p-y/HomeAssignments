!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="828b38d2-06a7-39cf-9e68-b5c65316e1fa")}catch(e){}}();
define(["require","exports","./c_chat_dialogue_dialogue_stone_proto_transformer","./c_memoize-one","react-dom","react","./c_api_v2_routes_growth_provider","./e_file_viewer_static_scl_page_file"],(function(t,e,i,a,s,o,n,r){"use strict";function h(t){return t&&t.__esModule?t:{default:t}}function c(t){if(t&&t.__esModule)return t;var e=Object.create(null);return t&&Object.keys(t).forEach((function(i){if("default"!==i){var a=Object.getOwnPropertyDescriptor(t,i);Object.defineProperty(e,i,a.get?a:{enumerable:!0,get:function(){return t[i]}})}})),e.default=t,Object.freeze(e)}var d=c(s),_=h(o);const C=t=>void 0!==t.campaignId,E=t=>"string"==typeof t,p=(t,e)=>!!t&&(C(t)&&C(e)?t.campaignId===e.campaignId:!(!E(t)||!E(e))&&t===e),T=t=>C(t)?t.systemSettings&&"snapengageChatSystemSettings"===t.systemSettings.case?t.systemSettings.value.widgetId:null:t;var g,l,S;!function(t){t.UNKNOWN="unknown",t.OFFLINE="offline",t.ONLINE="online"}(g||(g={})),function(t){t.START_TRANSFER="startTransfer",t.END_TRANSFER="endTransfer",t.ERROR_ON_TRANSFER="errorOnTransfer"}(l||(l={}));class O{constructor(t){}}class u{constructor(t,e){this.setupChatEnvironment=t=>{},this.startReactiveChat=()=>{},this.startSupportChat=t=>{},this.setCookieBannerInfo=t=>{},this.regsiterVisibilityChangeCallback=t=>{}}}class A extends O{constructor(t){super(t),this.DEFAULT_WIDGET_ID="d5c1efed-d0ef-4fca-8c7d-faff398ad272",this.getDefaultChatIdentifier=()=>this.DEFAULT_WIDGET_ID,this.loadChatIfNecessary=t=>{},this.requestAgentStatusUpdate=t=>{},this.showProviderReactiveChatButton=()=>{},this.handleProviderDrivenOpen=()=>{},this.startChat=(t,e)=>{},this.updateHmac=()=>{},this.addBottomMargin=()=>{},this.removeBottomMargin=()=>{},this.handleTransferEvent=t=>{}}}e.DialogueActionType=void 0,(S=e.DialogueActionType||(e.DialogueActionType={})).INIT_PROVIDER="DIALOGUE/INIT_PROVIDER",S.SET_TRANSFER_PROPS="DIALOGUE/SET_TRANSFER_PROPS",S.START_TRANSFER="DIALOGUE/START_TRANSFER",S.END_CHAT="DIALOGUE/END_CHAT",S.GET_CHAT="DIALOGUE/GET_CHAT",S.TOGGLE_CHAT_WINDOW="DIALOGUE/TOGGLE_CHAT_WINDOW",S.TOGGLE_REACTIVE_BUTTON="DIALOGUE/TOGGLE_REACTIVE_BUTTON",S.TOGGLE_END_CHAT_MODAL="DIALOGUE/TOGGLE_END_CHAT_MODAL",S.TOGGLE_TRANSFER_MODAL="DIALOGUE/TOGGLE_TRANSFER_MODAL",S.SET_LOGGING_ID="DIALOGUE/SET_LOGGING_ID",S.SET_GREETING_MESSAGE="DIALOGUE/SET_GREETING_MESSAGE",S.SET_FATAL_ERROR_MESSAGE="DIALOGUE/SET_FATAL_ERROR_MESSAGE",S.DISABLE_CHAT="DIALOGUE/DISABLE_CHAT",S.ADD_MESSAGE="DIALOGUE/ADD_MESSAGE",S.UPDATE_CURRENT_MESSAGE="DIALOGUE/UPDATE_CURRENT_MESSAGE",S.UPDATE_SURVEY_RESPONSE="DIALOGUE/UPDATE_SURVEY_RESPONSE",S.CLICK_LINK="DIALOGUE/CLICK_LINK",S.RESTART_CHAT="DIALOGUE/RESTART_CHAT";const R=_.default.lazy((async()=>{const{Dialogue:e}=await new Promise((function(e,i){t(["./c_chat_dialogue"],e,i)}));return{default:e}})),m=()=>_.default.createElement(_.default.Fragment,null),I=t=>_.default.createElement(_.default.Suspense,{fallback:_.default.createElement(m,null)},_.default.createElement(R,{...t}));class v extends O{constructor(a){var s;super(a),this.DEFAULT_ID="chatbot",this.isReady=!1,this.setup=async()=>{const e=new Promise((function(e,i){t(["./c_dialogue_reducers_index"],e,i)})).then((({createAppRootStore:t})=>{this.initialiseReduxStore(t),this.loadChat()})),i=new Promise((function(e,i){t(["./c_dialogue_actions_chat_actions"],e,i)})).then((function(t){return t.chat_actions_esnext}));await Promise.all([e,i]),i.then((t=>{this.chatActions=t;const e={text:this.campaign.greetingMessage,sender:"bot"};this.callWhenReady((()=>{this.action(this.chatActions.getChat(this.stoneSettings,e,Number(this.campaign.campaignId)))})),this.isReady=!0,this.onReadyCallbacks.forEach((t=>{t()}))})),this.onChatLoadStatusListener(this.campaign,!0)},this.initialiseReduxStore=t=>{this.store=t(this);const i=(t=>{const e={};return t.forEach((t=>{const i=t.name;e[i]=t.active})),e})(this.settings.experiments);this.store.dispatch({type:e.DialogueActionType.INIT_PROVIDER,settings:this.stoneSettings,userProperties:this.userProperties,experiments:i,campaignId:Number(this.campaign.campaignId)})},this.action=t=>{t(this.store.dispatch,this.store.getState)},this.transferToNewCampaign=t=>{t.chatProviderType===i.ChatProviderType.SNAPENGAGE&&this.onSwitchProviderWithNewCampaign(t,this.campaign)},this.handleTransferEvent=t=>{var e,i;if(t===l.START_TRANSFER);else if(t===l.END_TRANSFER){const{providerState:t}=this.store.getState(),a=null===(e=t.savedTransferProps)||void 0===e?void 0:e.campaignResult;let s;if(a){const{campaignName:t,versionName:e,campaignId:i}=a;s=`chatbot_transfer_${i}`,this.logAsync("transfer",{campaignName:t,versionName:e,campaignId:Number(i)})}this.action(this.chatActions.endChat({},this.stoneSettings,!1,s)),null===(i=this.getRootElement())||void 0===i||i.remove()}else t===l.ERROR_ON_TRANSFER&&this.addMessage({text:"Sorry, I wasn't able to transfer you.",sender:"bot"})},this.onReactiveButtonShown=()=>{this.onProviderReactiveButtonShownListener(this.campaign)},this.addMessage=(t,i=!1)=>{this.callWhenReady((()=>{this.store.dispatch({type:e.DialogueActionType.ADD_MESSAGE,message:t,awaitingResponse:i})}))},this.addBottomMargin=()=>{const t=this.getRootElement();t&&t.style.setProperty("transform","translateY(calc(-1 * var(--privacy-consent-banner-height, 0px)))")},this.removeBottomMargin=()=>{const t=this.getRootElement();t&&t.style.removeProperty("transform")},this.callWhenReady=t=>{this.isReady?t():this.onReadyCallbacks.push(t)},this.getRootElement=()=>document.getElementById("dialogue-chat-root"),this.getLogger=async()=>{if(this.logger)return this.logger;const{DialogueEventsLogger:e}=await new Promise((function(e,i){t(["./c_chat_dialogue_logging"],e,i)}));return this.logger=new e,this.logger},this.logAsync=async(t,e={})=>{(await this.getLogger()).logEvent(t,e)},this.settings=(null===(s=a.chatCampaign)||void 0===s?void 0:s.systemSettings).value,this.stoneSettings=i.convertProtoSettingsToStone(this.settings),this.campaign=a.chatCampaign,this.userProperties=a.userProperties,this.onReadyCallbacks=[],this.onAgentStatusUpdateListener=a.onAgentStatusUpdate,this.onChatLoadStatusListener=a.onChatLoadStatusUpdate,this.onChatShownListener=a.onChatShown,this.onChatStartedListener=a.onChatStarted,this.onChatClosedListener=a.onChatClosed,this.onChatMinimizedListener=a.onChatMinimized,this.onChatMaximizedListener=a.onChatMaximized,this.onProviderDrivenOpenProactive=a.onProviderDrivenOpenProactive,this.onProviderReactiveButtonShownListener=a.onProviderReactiveButtonShown,this.onSwitchProviderWithNewCampaign=a.onSwitchProviderWithNewCampaign,this.hasLoaded=!1,this.setup().catch((async t=>{var e;(await this.getLogger()).logError("provider_init",{userId:null===(e=a.userProperties)||void 0===e?void 0:e.userId,error:t.toString()})}))}getDefaultChatIdentifier(){return this.DEFAULT_ID}loadChatIfNecessary(t){}requestAgentStatusUpdate(t){this.onAgentStatusUpdateListener(t,g.ONLINE)}showProviderReactiveChatButton(){this.callWhenReady((()=>{this.action(this.chatActions.toggleReactiveButton(!0))}))}handleProviderDrivenOpen(){}startChat(t,e){this.callWhenReady((()=>{this.action(this.chatActions.openChat(e))}))}updateHmac(){}onChatStarted(){this.onChatStartedListener(this.campaign)}onChatClosed(){this.onChatClosedListener(this.campaign,{})}onChatMinimized(){this.onChatMinimizedListener(this.campaign)}onChatMaximized(){this.onChatMaximizedListener(this.campaign)}onChatShown(t){this.onChatShownListener(t||this.campaign)}async loadChat(){if(!this.getRootElement()){const t=document.createElement("div");t.setAttribute("id","dialogue-chat-root"),document.body.appendChild(t)}this.hasLoaded||(d.render(_.default.createElement(I,{store:this.store,portaled:this.settings.portaled}),this.getRootElement()),this.hasLoaded=!0)}}const N=new class{constructor(){this.getChatProvider=(t,e)=>{if(t===i.ChatProviderType.SNAPENGAGE)return new A(e);if(t===i.ChatProviderType.DIALOGUE_CHAT)return new v(e);throw new Error(`Unknown chat provider type ${t}`)}}};function f(t){return"1508d082-aa3d-468f-9ac3-cfeb7d5a8435"===t||"c0b3fc4d-5e75-4c65-b5c0-db72be2085f7"===t}var P,D,L,y,U,V;!function(t){t.INITIALIZED="initialized",t.IMPRESSION_FAILED="impression_failed",t.CLICK="click",t.IMPRESSION="impression",t.INTERACT="interact",t.DISMISSED="dismissed",t.CLOSE="close",t.ERROR="error",t.TRANSFER="transfer"}(P||(P={})),function(t){t.CONTROL_VERSION="control_version",t.NO_ONLINE_AGENTS="no_online_agents",t.NOT_ENOUGH_TIME_ON_PAGE="not_enough_time_on_page",t.CHAT_IS_NOT_ALLOWED="chat_is_not_allowed",t.CHAT_IS_NOT_INITIALIZED="chat_is_not_initialized",t.ANOTHER_CHAT_STARTED="another_chat_started",t.COOLOFF_PERIOD="COOLOFF_PERIOD"}(D||(D={})),function(t){t.CHAT_ICON="chat_icon",t.PROACTIVE_CHAT="proactive_chat",t.RESUMED_CHAT="resumed_chat",t.REACTIVE_CHAT="reactive_chat"}(L||(L={})),function(t){t.UNKNOWN="unknown",t.RESUMED_CHAT="resumed_chat",t.PROACTIVE_CHAT="proactive_chat",t.REACTIVE_CHAT="reactive_chat",t.TRANSFERRED_CHAT="transferred_chat"}(y||(y={})),function(t){t.ATTEMPT_TO_START_UNINITIALIZED_CHAT="attempt_to_start_uninitialized_chat",t.CHAT_STARTED_FROM_UNKNOWN_SOURCE="chat_started_from_unknown_source",t.ATTEMPT_START_PROACTIVE_CHAT_WITHOUT_MESSAGE="attempt_start_proactive_chat_without_message"}(U||(U={})),function(t){t.DEFAULT="default",t.HIVE_VORTEX_COMBO="hive_vortex_combo"}(V||(V={}));class w{constructor(t){this.logger=t}logEvent(t,e,i){const a={entity_type:"chat",event_name:t,correlation_id:e.correlationId,event_id:i,user_id:this.toNumber(e.userId),entity_id:this.toNumber(e.campaignId),version_id:this.toNumber(e.versionId),platform:e.platform,event_details:this.getEventDetails(t,e)};this.logger.log(new r.MegaphoneEventsRow(a))}toNumber(t,e=-1){return null==t||""===t?e:"string"==typeof t?parseInt(t,10):"number"==typeof t?t:t.toNumber()}getEventDetails(t,e){const i={...e.eventDetails};let a=e.widgetId;return e.eventDetails.widgetOverride&&(a=e.eventDetails.widgetOverride),i.widget_id=a,i}}const H=new r.HiveLogger,W=new r.VortexComboLogger;const G=new class{getChatLogger(t=V.DEFAULT){const e=t===V.HIVE_VORTEX_COMBO?W:H;return new w(e)}};function M(t){var e,i,a;const s=null!==(e=null==t?void 0:t.path)&&void 0!==e?e:"/team/admin/engaged_chat",o=null!==(i=null==t?void 0:t.routeParams)&&void 0!==i?i:{},n=null!==(a=null==t?void 0:t.base)&&void 0!==a?a:window.location.origin;return new r.AjaxURL(r.replacePattern(s,o),n)}const b="MegaphoneChatCooloff";var F,B;!function(t){t[t.NOT_SHOWN=0]="NOT_SHOWN",t[t.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD=1]="TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD",t[t.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE=2]="TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE",t[t.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON=3]="REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON",t[t.SHOWING_PROVIDER_REACTIVE_BUTTON=4]="SHOWING_PROVIDER_REACTIVE_BUTTON",t[t.SHOWING_CHAT=5]="SHOWING_CHAT",t[t.TO_START_ON_LOAD=6]="TO_START_ON_LOAD",t[t.TO_START_ON_AGENT_STATUS_UPDATE=7]="TO_START_ON_AGENT_STATUS_UPDATE",t[t.REQUESTED_PROVIDER_TO_START_CHAT=8]="REQUESTED_PROVIDER_TO_START_CHAT",t[t.CHAT_ONGOING=9]="CHAT_ONGOING"}(F||(F={})),function(t){t[t.REACTIVE=0]="REACTIVE",t[t.PROACTIVE=1]="PROACTIVE",t[t.RESUME=2]="RESUME",t[t.TRANSFER=3]="TRANSFER",t[t.PROVIDER_DRIVEN_PROACTIVE=4]="PROVIDER_DRIVEN_PROACTIVE"}(B||(B={}));class k extends u{constructor(t,e,s){super(t,e),this.setupChatEnvironment=t=>{if(this._isSetup)return;if(t.featureGates.enable_vortex_logger&&(this.logger=this.loggerFactory.getChatLogger(V.HIVE_VORTEX_COMBO)),!this.shouldAllowChat())return;if(this.initProperties=t,this.setupTime=new Date,this.hasFirstLoadOccured=!1,this.state={lifecycleState:F.NOT_SHOWN,hasShownAChat:!1,interactedWithChat:!1,cookieBannerState:{isVisible:!1}},!t.chatMetadata)throw new Error("Did not provide chat metadata.");if(this.metadata=t.chatMetadata,!t.userProperties)throw new Error("Did not provide user properties.");const e=this.getChatProviderMetadata(t),a=t.campaignResult;if(this.setupProvider(a,e,t.userProperties,t.chatProviderType),a&&a.isControl)this.setupControlLogging(a);else{const e=a&&a.chatInitialState===i.ChatInitialState.SHOW_PROVIDER_REACTIVE_BUTTON;if(t.resume){const t=this.chatCampaignWrapper||this.defaultChatWrapper;this.deprecatedLogChatAction("chat_persistence",T(t.chatCampaign)),this.intializeStartingChat(t,B.RESUME)}else this.setupProactivePropertiesIfNeeded(),e&&(this.attemptToShowProviderReactiveChatButton(),this.deprecatedMaybeLogExperiment(a))}window.addEventListener("beforeunload",(()=>{this.maybeLogImpressionFailedOnUnload()}))},this.startReactiveChat=()=>{if(!this.hasFirstLoadOccured)return void this.deferStartChat();if(this.logEvent(P.CLICK,{source:"startReactiveChat"}),!this.shouldAllowChat())return void this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.CHAT_IS_NOT_ALLOWED});if(this.logAndRaiseIfNotSetup(),!this.canStartChat())return;let t=this.chatCampaignWrapper;const e=t&&C(t.chatCampaign)&&t.chatCampaign.isControl;if(!this.chatCampaignWrapper||e)return t=this.defaultChatWrapper,this.deprecatedLogChatAction("chat_initiated",T(t.chatCampaign)),void this.intializeStartingChat(t,B.REACTIVE);this.deprecatedLogChatAction("chat_initiated",T(t.chatCampaign)),this.intializeStartingChat(this.chatCampaignWrapper,B.REACTIVE)},this.startSupportChat=t=>{this.hasFirstLoadOccured?(this.logEvent(P.CLICK,{source:"startSupportChat",widgetOverride:t}),this.shouldAllowChat()?(this.logAndRaiseIfNotSetup(),this.canStartChat()&&(this.supportChatWrapper={chatCampaign:t,chatCampaignState:this.getInitialChatCampaignState()},f(t)&&r.WebRequest$1({url:M(),data:{chatId:t}}),this.deprecatedLogChatAction("support_chat_initiated",t),this.intializeStartingChat(this.supportChatWrapper,B.REACTIVE))):this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.CHAT_IS_NOT_ALLOWED,widgetOverride:t})):this.deferStartChat(t)},this.isSetup=()=>this._isSetup,this.setCookieBannerInfo=t=>{this.state.cookieBannerState={isVisible:t},this.adjustProviderMarginOnStateChange()},this.regsiterVisibilityChangeCallback=t=>{this.onVisibilityChangeCallbacks.push(t)},this.deferStartChat=t=>{this.deferredStartChatCallback=()=>{t?this.startSupportChat(t):this.startReactiveChat()}},this.updateChatVisibility=t=>{this.onVisibilityChangeCallbacks.forEach((e=>e(t)))},this.adjustProviderMarginOnStateChange=()=>{this.state.cookieBannerState.isVisible?this.state.lifecycleState===F.CHAT_ONGOING||this.state.lifecycleState===F.SHOWING_CHAT?this.provider.removeBottomMargin():this.provider.addBottomMargin():this.provider.removeBottomMargin()},this.modifyLifecycleState=t=>{this.state.lifecycleState=t,this.adjustProviderMarginOnStateChange()},this.logAndRaiseIfNotSetup=()=>{if(!this._isSetup)throw this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.CHAT_IS_NOT_INITIALIZED}),this.logError(U.ATTEMPT_TO_START_UNINITIALIZED_CHAT),new Error("Started chat without being initialized")},this.setupProvider=(t,e,i,a)=>{const s={chatCampaign:t,metadata:e,userProperties:i,onAgentStatusUpdate:this.onAgentStatusUpdate,onChatLoadStatusUpdate:this.onChatLoadStatusUpdate,onChatShown:this.onChatShown,onChatStarted:this.onChatStarted,onChatClosed:this.onChatClosed,onChatMinimized:this.onChatMinimized,onChatMaximized:this.onChatMaximized,onProviderDrivenOpenProactive:this.onProviderDrivenOpenProactive,onProviderReactiveButtonShown:this.onProviderReactiveButtonShown,onSwitchProviderWithNewCampaign:this.onSwitchProviderWithNewCampaign};t&&(this.chatCampaignWrapper={chatCampaign:t,chatCampaignState:this.getInitialChatCampaignState()}),this.provider=this.getChatProvider(a,s),this.defaultChatWrapper={chatCampaign:this.provider.getDefaultChatIdentifier(),chatCampaignState:this.getInitialChatCampaignState()},this._isSetup=!0},this.attemptToShowProviderReactiveChatButton=()=>{const t=this.chatCampaignWrapper;t&&C(t.chatCampaign)&&(this.state.campaign=t.chatCampaign,this.state.source_type=B.REACTIVE,t.chatCampaignState.isLoaded?C(t.chatCampaign)&&t.chatCampaign.mustHaveAvailableAgents?this.attemptToShowReactiveButtonChatThatMustHaveAgents(t):this.requestProviderToShowProviderReactiveButton():this.requestProviderToLoadChatToShowProviderReactiveButton(t))},this.requestProviderToShowProviderReactiveButton=()=>{this.modifyLifecycleState(F.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON),this.provider.showProviderReactiveChatButton();const t=this.chatCampaignWrapper||this.defaultChatWrapper;this.deprecatedLogChatAction("minimized_chat_initiated",T(t.chatCampaign))},this.requestProviderToGetAgentStatusUpdateToShowProviderReactiveButton=t=>{this.modifyLifecycleState(F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE),this.provider.requestAgentStatusUpdate(t.chatCampaign)},this.requestProviderToLoadChatToShowProviderReactiveButton=t=>{this.modifyLifecycleState(F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD),this.provider.loadChatIfNecessary(t.chatCampaign)},this.canStartChat=()=>{const t=this.state.lifecycleState;return t===F.NOT_SHOWN||t===F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD||t===F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE||t===F.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON||t===F.SHOWING_PROVIDER_REACTIVE_BUTTON},this.intializeStartingChat=(t,e)=>{this.state.source_type=e,this.state.campaign=t.chatCampaign,this.attemptToStartChat(t)},this.attemptToStartChat=t=>{const e=this.state.source_type,i=e===B.PROACTIVE||e===B.PROVIDER_DRIVEN_PROACTIVE;t.chatCampaignState.isLoaded?i&&C(t.chatCampaign)&&t.chatCampaign.mustHaveAvailableAgents?this.attemptToStartChatThatMustHaveAgents(t,e===B.PROVIDER_DRIVEN_PROACTIVE):e===B.PROVIDER_DRIVEN_PROACTIVE?this.requestProviderToHandleProviderDrivenOpen():this.requestProviderToStartChat(t):this.requestProviderToLoadChatToStartChat(t)},this.requestProviderToHandleProviderDrivenOpen=()=>{this.provider.handleProviderDrivenOpen(),this.modifyLifecycleState(F.SHOWING_CHAT)},this.requestProviderToStartChat=t=>{this.modifyLifecycleState(F.REQUESTED_PROVIDER_TO_START_CHAT),this.provider.startChat(t.chatCampaign,this.state.source_type===B.PROACTIVE)},this.requestProviderToGetAgentStatusUpdateToStartChat=t=>{this.modifyLifecycleState(F.TO_START_ON_AGENT_STATUS_UPDATE),this.provider.requestAgentStatusUpdate(t.chatCampaign)},this.setupProactivePropertiesIfNeeded=()=>{const t=this.chatCampaignWrapper;if(!t||!C(t.chatCampaign))return;const e=t.chatCampaign,i=e.proactiveSettings;if(!i||i.whenToShowControlledByProvider||e.isControl)return;if(!e.greetingMessage)return void this.logError(U.ATTEMPT_START_PROACTIVE_CHAT_WITHOUT_MESSAGE);const a=this.readProactiveChatCooloffCookie();if(a)return void this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.COOLOFF_PERIOD,debug_info:a},e);const s=1e3*Number(i.secondsUntilShown);setTimeout((()=>{this.state.hasShownAChat||this.state.campaign&&this.state.campaign!==e?this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.ANOTHER_CHAT_STARTED},e):this.intializeStartingChat(t,B.PROACTIVE)}),s)},this.setupControlLogging=t=>{const e=t.proactiveSettings,i=()=>{let e=D.CONTROL_VERSION;this.readProactiveChatCooloffCookie()?e=D.COOLOFF_PERIOD:this.state.campaign&&this.state.campaign!==t?e=D.ANOTHER_CHAT_STARTED:this.chatCampaignWrapper&&this.chatCampaignWrapper.chatCampaignState.agentStatus!==g.ONLINE&&C(this.chatCampaignWrapper.chatCampaign)&&this.chatCampaignWrapper.chatCampaign.mustHaveAvailableAgents&&(e=D.NO_ONLINE_AGENTS),this.logEvent(P.IMPRESSION_FAILED,{failed_reason:e},t)};if(!e)return void i();const a=1e3*Number(e.secondsUntilShown);setTimeout(i,a),setTimeout((()=>this.deprecatedMaybeLogExperiment(t)),a)},this.getPersistenceCookie=t=>C(t)?t.persistenceCookie:`SNAPENGAGE:${t}`,this.setChatVisibleCookie=t=>{if(!this.metadata)return;const e=this.getPersistenceCookie(t),i=this.getLegacyCampaignIdentifierToCookieStr(t);i&&a.Cookies.create(this.metadata.legacyCookieCampaignName,i,.084,this.metadata.cookieDomain),a.Cookies.create(this.metadata.cookieCampaignName,e,1,this.metadata.cookieDomain)},this.maybeSetProactiveChatCooloffCookie=(t,e)=>{if(this.metadata&&t===B.PROACTIVE&&e&&C(e.chatCampaign)&&e.chatCampaign.proactiveSettings&&e.chatCampaign.proactiveSettings.coolOffPeriodMinutes){const t=e.chatCampaign,i=(new Date).getTime(),s=`${t.campaignId}:${t.versionId}:${i}`,o=Number(t.proactiveSettings.coolOffPeriodMinutes)/1440;a.Cookies.create(b,s,o,this.metadata.cookieDomain)}},this.readProactiveChatCooloffCookie=()=>a.Cookies.read(b),this.getInitialChatCampaignState=()=>({isLoaded:!1,agentStatus:g.UNKNOWN}),this.getWrapperFromIdentifier=t=>this.chatCampaignWrapper&&p(this.chatCampaignWrapper.chatCampaign,t)?this.chatCampaignWrapper:p(this.defaultChatWrapper.chatCampaign,t)?this.defaultChatWrapper:this.supportChatWrapper&&p(this.supportChatWrapper.chatCampaign,t)?this.supportChatWrapper:void 0,this.getLegacyCampaignIdentifierToCookieStr=t=>C(t)?"snapengageChatSystemSettings"===t.systemSettings.case?t.systemSettings.value.widgetId:null:t,this.legacyToggleOutsideChatVisibilityOnAgentStatusUpdate=t=>{this.modifyVisibility("[data-snap-engage-visibility]",!1),t===g.ONLINE?this.modifyVisibility('[data-snap-engage-visibility="online"]',!0):this.modifyVisibility('[data-snap-engage-visibility="offline"]',!0)},this.modifyVisibility=(t,e)=>{const i=e?"inline":"none",a=document.querySelectorAll(t);for(let t=0;t<a.length;t++){const e=a[t];e instanceof HTMLElement&&(e.style.display=i)}},this.onAgentStatusUpdate=(t,e)=>{const i=p(this.state.campaign,t),a=this.state.lifecycleState,s=a===F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_AGENT_STATUS_UPDATE&&i,o=a===F.TO_START_ON_AGENT_STATUS_UPDATE&&i,n=this.getWrapperFromIdentifier(t);void 0!==n&&(n.chatCampaignState.agentStatus=e,this.legacyToggleOutsideChatVisibilityOnAgentStatusUpdate(e),s?this.attemptToShowProviderReactiveChatButton():o&&this.attemptToStartChat(n))},this.onChatLoadStatusUpdate=(t,e)=>{if(!this.hasFirstLoadOccured&&e){this.hasFirstLoadOccured=!0;const e=((new Date).valueOf()-this.setupTime.valueOf()).toString();this.logEvent(P.INITIALIZED,{init_latency_ms:e}),this.deprecatedLogChatAction("snapengage_loaded",T(t),{total_time:e}),this.deferredStartChatCallback&&this.deferredStartChatCallback()}const i=p(this.state.campaign,t),a=this.state.lifecycleState,s=a===F.TO_SHOW_PROVIDER_REACTIVE_BUTTON_ON_LOAD&&i,o=a===F.TO_START_ON_LOAD&&i,n=this.getWrapperFromIdentifier(t);void 0!==n&&(n.chatCampaignState.isLoaded=e,e&&this.provider.requestAgentStatusUpdate(t),s?this.attemptToShowProviderReactiveChatButton():o&&this.attemptToStartChat(n))},this.onProviderReactiveButtonShown=()=>{this.state.lifecycleState===F.REQUESTED_PROVIDER_TO_SHOW_REACTIVE_BUTTON&&(this.modifyLifecycleState(F.SHOWING_PROVIDER_REACTIVE_BUTTON),this.logEvent(P.IMPRESSION,{impression_type:L.CHAT_ICON}))},this.onProviderDrivenOpenProactive=t=>{this.chatCampaignWrapper&&p(this.chatCampaignWrapper.chatCampaign,t)&&(this.state.hasShownAChat||(this.logEvent(P.IMPRESSION,{impression_type:L.PROACTIVE_CHAT}),this.deprecatedMaybeLogExperiment(t),this.deprecatedLogChatAction("proactive_chat_opened",T(t)),this.canStartChat()&&this.intializeStartingChat(this.chatCampaignWrapper,B.PROVIDER_DRIVEN_PROACTIVE))),this.updateChatVisibility(!0)},this.onChatShown=t=>{this.state.lifecycleState!==F.SHOWING_PROVIDER_REACTIVE_BUTTON&&this.state.lifecycleState!==F.REQUESTED_PROVIDER_TO_START_CHAT||p(this.state.campaign,t),this.modifyLifecycleState(F.SHOWING_CHAT),this.state.campaign=t,this.state.hasShownAChat=!0,this.state.source_type===B.RESUME?(this.provider.updateHmac(),this.state.interactedWithChat=!0,this.logEvent(P.IMPRESSION,{impression_type:L.RESUMED_CHAT})):this.state.source_type!==B.REACTIVE||this.impressionLogged||this.logEvent(P.IMPRESSION,{impression_type:L.REACTIVE_CHAT}),this.updateChatVisibility(!0)},this.onChatStarted=t=>{const e=this.state.source_type;if(void 0!==e){let i;this.state.interactedWithChat=!0;let a=y.UNKNOWN;e===B.RESUME?(i="chat_persistence_init",a=y.RESUMED_CHAT):e===B.PROACTIVE||e===B.PROVIDER_DRIVEN_PROACTIVE?(i="proactive_chat_initiated",a=y.PROACTIVE_CHAT,f(T(t))&&r.WebRequest$1({url:M(),data:{chatId:T(t)}})):e===B.REACTIVE?(i="reactive_chat_initiated",a=y.REACTIVE_CHAT):e===B.TRANSFER&&(a=y.TRANSFERRED_CHAT),this.logEvent(P.INTERACT,{interaction_type:a}),void 0!==i&&this.deprecatedLogChatAction(i,T(t))}else this.logError(U.CHAT_STARTED_FROM_UNKNOWN_SOURCE);this.setChatVisibleCookie(t),this.modifyLifecycleState(F.CHAT_ONGOING)},this.onChatClosed=(t,e)=>{let i;this.handleCookieOnClosed(this.state.source_type,this.chatCampaignWrapper);let a=g.UNKNOWN;void 0!==e.agentStatus&&(i=e.agentStatus===g.ONLINE?"online":"offline",a=e.agentStatus===g.ONLINE?g.ONLINE:g.OFFLINE),this.deprecatedLogChatAction("snapengage_chat_close",T(t),{type:e.chatType,agent_status:i});const s=this.state.interactedWithChat?P.CLOSE:P.DISMISSED;this.logEvent(s,{agents_status:a,chat_form_type:e.chatType}),this.updateChatVisibility(!1),this.resetChatState()},this.onChatMinimized=t=>{this.updateChatVisibility(!1),this.modifyLifecycleState(F.SHOWING_PROVIDER_REACTIVE_BUTTON)},this.onChatMaximized=t=>{this.updateChatVisibility(!0),this.modifyLifecycleState(F.SHOWING_CHAT)},this.onSwitchProviderWithNewCampaign=(t,e)=>{const i=this.provider;let a;i.handleTransferEvent(l.START_TRANSFER);try{const e=this.getChatProviderMetadata(t);if(!t.userProperties)throw new Error("User properties cannot be empty");this.setupProvider(t.campaignResult,e,t.userProperties,t.chatProviderType),a=t.campaignResult}catch{return void i.handleTransferEvent(l.ERROR_ON_TRANSFER)}this.logEvent(P.TRANSFER,{},a),this.onChatLoadStatusUpdate(e,!1),this.onAgentStatusUpdate(e,g.UNKNOWN),this.resetChatState(),this.provider.requestAgentStatusUpdate(a),i.handleTransferEvent(l.END_TRANSFER),this.setChatVisibleCookie(a),this.intializeStartingChat(this.chatCampaignWrapper,B.TRANSFER)},this.getChatProviderMetadata=t=>{let e;if("snapengageChatMetadata"===t.chatProviderMetadata.case)e=t.chatProviderMetadata.value;else if(t.chatProviderType!==i.ChatProviderType.DIALOGUE_CHAT)throw new Error("No provider metadata provided");return e},this.maybeLogImpressionFailedOnUnload=()=>{if(!this.impressionLogged){const t=(new Date).valueOf()-this.setupTime.valueOf();this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.NOT_ENOUGH_TIME_ON_PAGE,time_on_page_ms:t.toString()})}},this.logEvent=(t,e,i)=>{t!==P.IMPRESSION&&t!==P.IMPRESSION_FAILED||(this.impressionLogged=!0),this.logger.logEvent(t,this.createEventData(e,i))},this.logError=t=>{this.logEvent(P.ERROR,{error_type:t})},this.createEventData=(t,e)=>{let i="-1",s=-1,o=-1,n="";if(this.initProperties.userProperties&&(i=this.initProperties.userProperties.userId),e)s=Number(e.campaignId),o=Number(e.versionId),n="snapengageChatSystemSettings"===e.systemSettings.case&&e.systemSettings.value.widgetId||"";else{const t=this.chatCampaignWrapper||this.defaultChatWrapper;t&&(n=T(t.chatCampaign)||"",C(t.chatCampaign)&&(s=Number(t.chatCampaign.campaignId),o=Number(t.chatCampaign.versionId)))}return t.chat_session_id||(t.chat_session_id=a.Cookies.read("SnapABugChatSession")||""),{userId:i,campaignId:s,versionId:o,widgetId:n,correlationId:this.initProperties.loggingCorrelationId,platform:"WEB",eventDetails:t}},this.loggerFactory=s,this.logger=s.getChatLogger(),this.getChatProvider=t,this.shouldAllowChat=e,this._isSetup=!1,this.onVisibilityChangeCallbacks=[]}attemptToShowReactiveButtonChatThatMustHaveAgents(t){const e=t.chatCampaignState.agentStatus;e===g.UNKNOWN?this.requestProviderToGetAgentStatusUpdateToShowProviderReactiveButton(t):e===g.OFFLINE?(this.deprecatedLogChatAction("chat_agent_must_be_online_but_was_offline",T(t.chatCampaign)),this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.NO_ONLINE_AGENTS}),this.resetChatState()):this.requestProviderToShowProviderReactiveButton()}attemptToStartChatThatMustHaveAgents(t,e){const i=t.chatCampaignState.agentStatus;i===g.UNKNOWN?this.requestProviderToGetAgentStatusUpdateToStartChat(t):i===g.OFFLINE?(this.logEvent(P.IMPRESSION_FAILED,{failed_reason:D.NO_ONLINE_AGENTS}),this.resetChatState()):e?this.requestProviderToHandleProviderDrivenOpen():this.requestProviderToStartChat(t)}requestProviderToLoadChatToStartChat(t){this.modifyLifecycleState(F.TO_START_ON_LOAD),this.provider.loadChatIfNecessary(t.chatCampaign)}handleCookieOnClosed(t,e){this.metadata&&(a.Cookies.delete(this.metadata.cookieCampaignName),a.Cookies.delete(this.metadata.legacyCookieCampaignName),this.maybeSetProactiveChatCooloffCookie(t,e))}deprecatedLogChatAction(t,e,i){if(!e)return;const a={...{chat_widget_id:e,url:r.get_href()},...i};r.TeamsWebActionsLogger.log(t,a),r.getAMPWebLogger().logEventCount("chat_events",t,{chat_widget_id:e})}deprecatedMaybeLogExperiment(t){C(t)}resetChatState(){this.modifyLifecycleState(F.NOT_SHOWN),this.state.campaign=void 0,this.state.source_type=void 0,this.state.interactedWithChat=!1}}const z=new k(N.getChatProvider,(()=>top===window),G);var x=Object.freeze({__proto__:null,ChatClientSingleton:z,get ChatStartSourceType(){return B},_ChatClientSingleton:k,moduleInit:function(t){const e=n.unmarshalProto(t,i.ChatInitializerProperties);z.setupChatEnvironment(e)}});e.chat_client_esnext=x}));
//# sourceMappingURL=c_chat_chat_client.js-vflLiX__L.map

//# debugId=828b38d2-06a7-39cf-9e68-b5c65316e1fa